[32mINFO    [0m juju.model:model.py:2098 Deploying ch:amd64/focal/mattermost-k8s-27
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  mattermost-k8s/0 [allocating] waiting: installing agent
  mattermost-k8s/1 [allocating] waiting: installing agent
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  mattermost-k8s/0 [executing] waiting: Waiting for database relation
  mattermost-k8s/1 [executing] waiting: Waiting for database relation
[33mWARNING [0m juju.model:model.py:1564 relate is deprecated and will be removed. Use integrate instead.
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  mattermost-k8s/0 [idle] waiting: Waiting for database relation
  mattermost-k8s/1 [idle] waiting: Waiting for database relation
[32mINFO    [0m juju.model:model.py:2972 Waiting for model:
  mattermost-k8s/0 [executing] active: 
  mattermost-k8s/1 [executing] waiting: Waiting for database relation
[32mINFO    [0m pytest_operator.plugin:plugin.py:903 Model status:

Model  Controller          Cloud/Region        Version  SLA          Timestamp
test   microk8s-localhost  microk8s/localhost  3.4.5    unsupported  01:44:28Z

App                       Version                         Status   Scale  Charm                     Channel        Rev  Address         Exposed  Message
mattermost-k8s            .../mattermost:v8.1.3-20.04...  waiting      2  mattermost-k8s            latest/stable   27  10.152.183.94   no       
pgbouncer-k8s             1.21.0                          active       2  pgbouncer-k8s                              0  10.152.183.166  no       
postgresql-k8s            14.12                           active       3  postgresql-k8s            14/edge        360  10.152.183.247  no       
postgresql-test-app                                       active       1  postgresql-test-app       latest/edge    227  10.152.183.173  no       received database credentials of the first database
self-signed-certificates                                  active       1  self-signed-certificates  latest/stable  155  10.152.183.83   no       

Unit                         Workload  Agent      Address     Ports     Message
mattermost-k8s/0*            error     idle       10.1.84.84  8065/TCP  container error: 
mattermost-k8s/1             waiting   executing  10.1.84.85  8065/TCP  waiting for container
pgbouncer-k8s/0              active    idle       10.1.84.72            
pgbouncer-k8s/1*             active    idle       10.1.84.73            
postgresql-k8s/0             active    idle       10.1.84.79            
postgresql-k8s/1             active    idle       10.1.84.81            
postgresql-k8s/2*            active    idle       10.1.84.80            Primary
postgresql-test-app/0*       active    idle       10.1.84.74            received database credentials of the first database
self-signed-certificates/0*  active    idle       10.1.84.78            

[32mINFO    [0m pytest_operator.plugin:plugin.py:909 Juju error logs:

unit-pgbouncer-k8s-0: 01:44:04 ERROR unit.pgbouncer-k8s/0.juju-log Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/venv/ops/model.py", line 3187, in _run
    result = subprocess.run(args, **kwargs)  # type: ignore
  File "/usr/lib/python3.10/subprocess.py", line 526, in run
    raise CalledProcessError(retcode, process.args,
subprocess.CalledProcessError: Command '('/var/lib/juju/tools/unit-pgbouncer-k8s-0/secret-get', '--label', 'backend-database.7.user.secret', '--format=json')' returned non-zero exit status 1.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/./src/charm.py", line 1045, in <module>
    main(PgBouncerK8sCharm)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/venv/ops/main.py", line 551, in main
    manager.run()
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/venv/ops/main.py", line 530, in run
    self._emit()
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/venv/ops/main.py", line 516, in _emit
    self.framework.reemit()
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/venv/ops/framework.py", line 870, in reemit
    self._reemit()
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/venv/ops/framework.py", line 950, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/src/relations/db.py", line 289, in _on_relation_changed
    if not self.charm.backend.check_backend():
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/src/relations/backend_database.py", line 459, in check_backend
    if not self.ready:
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/src/relations/backend_database.py", line 197, in ready
    if not self.postgres:
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/src/relations/backend_database.py", line 134, in postgres
    user = self.database.fetch_relation_field(self.relation.id, "username")
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1350, in fetch_relation_field
    self.fetch_relation_data([relation_id], [field], relation_name)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1342, in fetch_relation_data
    data[relation.id] = self._fetch_specific_relation_data(relation, fields)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1818, in _fetch_specific_relation_data
    return self._fetch_relation_data_with_secrets(
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1242, in _fetch_relation_data_with_secrets
    result, normal_fields = self._process_secret_fields(
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1186, in _process_secret_fields
    if group_result := operation(relation, group, secret_fields, *args, **kwargs):
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1119, in _get_group_secret_contents
    if (secret := self._get_relation_secret(relation.id, group)) and (
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 504, in wrapper
    return f(self, *args, **kwargs)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1810, in _get_relation_secret
    return self.secrets.get(label)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 808, in get
    if secret.meta:
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 638, in meta
    self._secret_meta = self._model.get_secret(label=self.label)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/venv/ops/model.py", line 291, in get_secret
    content = self._backend.secret_get(id=id, label=label)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/venv/ops/model.py", line 3552, in secret_get
    result = self._run('secret-get', *args, return_output=True, use_json=True)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-0/charm/venv/ops/model.py", line 3189, in _run
    raise ModelError(e.stderr) from e
ops.model.ModelError: ERROR cannot ensure service account "unit-pgbouncer-k8s-0": rpc error: code = Unknown desc = exec (try: 500): database is locked

unit-self-signed-certificates-0: 01:44:05 ERROR unit.self-signed-certificates/0.juju-log Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/venv/ops/model.py", line 3139, in _run
    result = subprocess.run(args, **kwargs)  # type: ignore
  File "/usr/lib/python3.10/subprocess.py", line 526, in run
    raise CalledProcessError(retcode, process.args,
subprocess.CalledProcessError: Command '('/var/lib/juju/tools/unit-self-signed-certificates-0/secret-get', '--label', 'ca-certificates', '--refresh', '--format=json')' returned non-zero exit status 1.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/./src/charm.py", line 342, in <module>
    main(SelfSignedCertificatesCharm)
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/venv/ops/main.py", line 548, in main
    manager.run()
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/venv/ops/main.py", line 527, in run
    self._emit()
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/venv/ops/main.py", line 516, in _emit
    _emit_charm_event(self.charm, self.dispatcher.event_name)
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/venv/ops/main.py", line 147, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/venv/ops/framework.py", line 348, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/venv/ops/framework.py", line 860, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/venv/ops/framework.py", line 950, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 647, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/./src/charm.py", line 202, in _configure
    self._send_ca_cert()
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 647, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/./src/charm.py", line 312, in _send_ca_cert
    secret_content = secret.get_content(refresh=True)
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/venv/ops/model.py", line 1377, in get_content
    self._content = self._backend.secret_get(id=self.id, label=self.label, refresh=refresh)
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/venv/ops/model.py", line 3504, in secret_get
    result = self._run('secret-get', *args, return_output=True, use_json=True)
  File "/var/lib/juju/agents/unit-self-signed-certificates-0/charm/venv/ops/model.py", line 3141, in _run
    raise ModelError(e.stderr) from e
ops.model.ModelError: ERROR cannot ensure service account "unit-self-signed-certificates-0": rpc error: code = Unknown desc = exec (try: 500): database is locked

unit-pgbouncer-k8s-1: 01:44:05 ERROR unit.pgbouncer-k8s/1.juju-log Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/venv/ops/model.py", line 3187, in _run
    result = subprocess.run(args, **kwargs)  # type: ignore
  File "/usr/lib/python3.10/subprocess.py", line 526, in run
    raise CalledProcessError(retcode, process.args,
subprocess.CalledProcessError: Command '('/var/lib/juju/tools/unit-pgbouncer-k8s-1/secret-get', '--label', 'backend-database.7.user.secret', '--format=json')' returned non-zero exit status 1.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/./src/charm.py", line 1045, in <module>
    main(PgBouncerK8sCharm)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/venv/ops/main.py", line 551, in main
    manager.run()
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/venv/ops/main.py", line 530, in run
    self._emit()
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/venv/ops/main.py", line 519, in _emit
    _emit_charm_event(self.charm, self.dispatcher.event_name)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/venv/ops/main.py", line 147, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/venv/ops/framework.py", line 348, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/venv/ops/framework.py", line 860, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/venv/ops/framework.py", line 950, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/./src/charm.py", line 532, in _on_update_status
    self.update_status()
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/lib/charms/tempo_k8s/v1/charm_tracing.py", line 735, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/./src/charm.py", line 547, in update_status
    if self.backend.postgres is None:
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/src/relations/backend_database.py", line 134, in postgres
    user = self.database.fetch_relation_field(self.relation.id, "username")
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1350, in fetch_relation_field
    self.fetch_relation_data([relation_id], [field], relation_name)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1342, in fetch_relation_data
    data[relation.id] = self._fetch_specific_relation_data(relation, fields)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1818, in _fetch_specific_relation_data
    return self._fetch_relation_data_with_secrets(
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1242, in _fetch_relation_data_with_secrets
    result, normal_fields = self._process_secret_fields(
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1186, in _process_secret_fields
    if group_result := operation(relation, group, secret_fields, *args, **kwargs):
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1119, in _get_group_secret_contents
    if (secret := self._get_relation_secret(relation.id, group)) and (
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 504, in wrapper
    return f(self, *args, **kwargs)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 1810, in _get_relation_secret
    return self.secrets.get(label)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 808, in get
    if secret.meta:
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/lib/charms/data_platform_libs/v0/data_interfaces.py", line 638, in meta
    self._secret_meta = self._model.get_secret(label=self.label)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/venv/ops/model.py", line 291, in get_secret
    content = self._backend.secret_get(id=id, label=label)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/venv/ops/model.py", line 3552, in secret_get
    result = self._run('secret-get', *args, return_output=True, use_json=True)
  File "/var/lib/juju/agents/unit-pgbouncer-k8s-1/charm/venv/ops/model.py", line 3189, in _run
    raise ModelError(e.stderr) from e
ops.model.ModelError: ERROR cannot ensure service account "unit-pgbouncer-k8s-1": rpc error: code = Unknown desc = exec (try: 500): database is locked

unit-pgbouncer-k8s-0: 01:44:05 ERROR juju.worker.uniter.operation hook "update-status" (via hook dispatching script: dispatch) failed: exit status 1
unit-self-signed-certificates-0: 01:44:05 ERROR juju.worker.uniter.operation hook "update-status" (via hook dispatching script: dispatch) failed: exit status 1
unit-pgbouncer-k8s-1: 01:44:05 ERROR juju.worker.uniter.operation hook "update-status" (via hook dispatching script: dispatch) failed: exit status 1

[32mINFO    [0m pytest_operator.plugin:plugin.py:991 Forgetting model main...